
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¨³å®šåº¦çœ‹æ¿ - å¸å®‰ Alpha</title>
    <meta name="description" content="åŸºäºèšåˆæˆäº¤ä¸Kçº¿çš„ç¨³å®šåº¦çœ‹æ¿ï¼šå®æ—¶é¢œè‰²åˆ¤å®šï¼ˆç»¿/é»„/çº¢ï¼‰ï¼Œå¸®åŠ©å¿«é€Ÿé€‰æ‹©ç›¸å¯¹ç¨³å®šçš„é¡¹ç›®ä»¥é™ä½ç£¨æŸé£é™©ã€‚">
    <meta name="keywords" content="å¸å®‰,Alpha,ç¨³å®šåº¦,åˆ·é‡,èšåˆæˆäº¤,Kçº¿,æ³¢åŠ¨ç‡">
    <link rel="stylesheet" href="/css/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/airdrop.css?v=1.0.42">
    <style>
        /* 4åˆ—è¡¨æ ¼å®½åº¦åˆ†é… */
        #stabilityTable th:nth-child(1),
        #stabilityTable td:nth-child(1) {
            width: 25% !important;
            text-align: left !important;
        }
        #stabilityTable th:nth-child(2),
        #stabilityTable td:nth-child(2) {
            width: 25% !important;
            text-align: center !important;
        }
        #stabilityTable th:nth-child(3),
        #stabilityTable td:nth-child(3) {
            width: 20% !important;
            text-align: left !important;
        }
        #stabilityTable th:nth-child(4),
        #stabilityTable td:nth-child(4) {
            width: 30% !important;
            text-align: center !important;
        }
        .status-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-weight:600}
        .status-green{background:rgba(34,197,94,.15);color:#22c55e}
        .status-yellow{background:rgba(240,185,11,.15);color:#f0b90b}
        .status-red{background:rgba(244,63,94,.15);color:#f43f5e}
        .muted{color:var(--muted)}
        .number{font-variant-numeric:tabular-nums}
        .small{font-size:.9em}
        .dot{width:8px;height:8px;border-radius:50%;display:inline-block}
        .dot.green{background:#22c55e}
        .dot.yellow{background:#f0b90b}
        .dot.red{background:#f43f5e}
        .note{color:var(--muted);font-size:12px;margin-top:8px}
        .rotating{animation:spin 1s linear}
        @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}
        .error{color:#f43f5e}
        .countdown-circle{
            width:32px;
            height:32px;
            border:2px solid rgba(255,255,255,0.3);
            border-radius:50%;
            display:flex;
            align-items:center;
            justify-content:center;
            position:relative;
            font-size:14px;
            font-weight:bold;
            color:var(--text);
        }
        .countdown-circle::before{
            content:'';
            position:absolute;
            top:-2px;
            left:-2px;
            right:-2px;
            bottom:-2px;
            border:2px solid transparent;
            border-top-color:#f0b90b;
            border-radius:50%;
            animation:countdown-rotate 15s linear infinite;
        }
        @keyframes countdown-rotate{
            from{transform:rotate(0deg)}
            to{transform:rotate(360deg)}
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <a href="/zh" class="logo">å¸å®‰ <span>Alpha</span> ç©ºæŠ•æ—¥å†</a>
            <button id="refreshButton" class="theme-toggle">
                <div class="countdown-circle">
                    <span id="countdownNumber">15</span>
                </div>
            </button>
            <div class="header-links">
                <a href="/zh" class="nav-link">ä»Šæ—¥ç©ºæŠ•</a>
                <a href="/zh/history.html" class="nav-link">å†å²ç©ºæŠ•</a>
                <a href="/zh/stability.html" class="nav-link active">ç¨³å®šåº¦</a>
            </div>
        </div>
    </header>
    <main class="main">
        <div class="container">
            <h2 class="section-title"><i class="bi bi-activity"></i> ç¨³å®šåº¦çœ‹æ¿</h2>


            <div class="airdrops-table-wrapper">
                <table class="airdrops-table" id="stabilityTable">
                    <thead>
                        <tr>
                            <th>é¡¹ç›®</th>
                            <th>ç¨³å®šåº¦</th>
                            <th>æœ€æ–°ä»·</th>
                            <th>4å€å‰©ä½™å¤©æ•°</th>
                        </tr>
                    </thead>
                    <tbody id="stabilityBody">
                        <tr><td colspan="4" class="muted" style="text-align:center;padding:24px">åŠ è½½ä¸­...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="note">
                <!-- ç§»é™¤æ›´æ–°æ—¶é—´æ˜¾ç¤º -->
            </div>
            <div id="errorBox" class="error small" style="display:none;margin-top:6px"></div>
        </div>
    </main>
    
    <!-- ç¨³å®šåº¦è¯´æ˜åŒºåŸŸ -->
    <div class="container" style="margin-bottom: 40px;">
        <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px;">
            <h4 style="color: #f0b90b; margin-bottom: 16px; font-size: 18px;">
                <i class="bi bi-info-circle"></i> ç¨³å®šåº¦è¯´æ˜
            </h4>
            <div style="line-height: 1.8; color: rgba(255,255,255,0.8);">
                <p style="margin-bottom: 12px; font-size: 14px; opacity: 0.7;">
                    ğŸ’¡ <strong>å°è´´å£«ï¼š</strong>ç³»ç»Ÿæ¯15ç§’è‡ªåŠ¨æ›´æ–°æ•°æ®ï¼Œä¼˜å…ˆé€‰æ‹©ç»¿è‰²é¡¹ç›®å‡å°‘ç£¨æŸ
                </p>
                <p style="margin-bottom: 12px; font-size: 13px; opacity: 0.6;">
                    âš™ï¸ åˆ¤å®šæ ‡å‡†åŸºäºä»·æ ¼åŒºé—´ã€æˆäº¤é‡æ³¢åŠ¨ã€å¼‚å¸¸æ¶¨è·Œå’ŒçŸ­æœŸè¶‹åŠ¿ç­‰å¤šä¸ªæŒ‡æ ‡ç»¼åˆè®¡ç®—
                </p>
                <p style="margin-bottom: 12px; font-size: 13px; opacity: 0.6;">
                    ğŸ“Š <strong>æ’åºè¯´æ˜ï¼š</strong>ä¸Šè¿°æŒ‰ç…§ç¨³å®šåº¦æ’åºï¼ŒKOGEæ˜¯1å€alphaå¯ä»¥ä½œä¸ºç¨³å®šåŸºçº¿ï¼Œæ¯”å®ƒé å‰å°±æ›´ç¨³å®š
                </p>
                <p style="margin: 0; font-size: 12px; opacity: 0.5; color: rgba(255,255,255,0.6);">
                    âš ï¸ <strong>å…è´£å£°æ˜ï¼š</strong>è¡Œæƒ…æ— æ³•é¢„æµ‹ï¼Œéœ€è‡ªè¡Œè§‚å¯Ÿå†å²æˆäº¤è®°å½•ï¼Œä¸å¯¹å› ä½¿ç”¨æœ¬ç«™æœåŠ¡é€ æˆçš„æŸå¤±æ‰¿æ‹…ä»»ä½•è´£ä»»
                </p>
            </div>
        </div>
    </div>
    
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-left">
                    <a href="https://alpha123.uk" class="footer-link"><i class="bi bi-globe2"></i> alpha123.uk</a>
                </div>
                <div class="footer-right">
                    <!-- ç§»é™¤è¯­è¨€é€‰æ‹©åŠŸèƒ½ -->
                </div>
            </div>
        </div>
    </footer>

    <script>
        const FEED_URL = '/stability_feed.json';

        // å¯è°ƒæ•´çš„é˜ˆå€¼é…ç½®
        const THRESHOLDS = {
            green: {
                range: 6,
                vol: 3,
                spike: 0.05, // 5%
                trend5m: 20
            },
            yellow: {
                range: 15,
                vol: 8,
                spike: 0.15, // 15%
                trend5m: 50
            }
        };

        let TOKENS = [];

        let feedTimer = null;

        let countdownTimer = null;
        let countdownSeconds = 15;
        let lastDataHash = '';
        let consecutiveErrors = 0;
        let backgroundTab = false;

        document.addEventListener('DOMContentLoaded', function(){
            document.getElementById('refreshButton').addEventListener('click', function(){
                refreshAll(true);
                resetCountdown();
            });
            
            // é¡µé¢å¯è§æ€§æ£€æµ‹
            document.addEventListener('visibilitychange', function() {
                backgroundTab = document.hidden;
                if (!backgroundTab) {
                    // é¡µé¢é‡æ–°å¯è§æ—¶ç«‹å³åˆ·æ–°
                    refreshAll(true);
                    resetCountdown();
                }
            });
            
            setupTimers();
            startCountdown();
        });



        function renderTableSkeleton(){
            const tbody = document.getElementById('stabilityBody');
            if (TOKENS.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="muted" style="text-align:center;padding:24px">åŠ è½½ä¸­...</td></tr>`;
                return;
            }
            tbody.innerHTML = TOKENS.map(t => {
                const needMap = String(t.symbol||'').includes('XXX');
                const multiplierDays = t.multiplier_days || 0;
                return `<tr data-symbol="${t.symbol}">
                    <td><strong>${t.display}</strong></td>
                    <td data-field="status">${needMap ? `<span class="status-chip status-yellow"><span class="dot yellow"></span><span>å¾…æ˜ å°„</span></span>` : `<span class="status-chip"><span class="dot"></span><span>è®¡ç®—ä¸­</span></span>`}</td>
                    <td class="number" data-field="lastPrice">-</td>
                    <td class="number" data-field="multiplierDays">${multiplierDays}</td>
                </tr>`;
            }).join('');
        }

        function setupTimers(){
            if (feedTimer) clearInterval(feedTimer);
            const iv = 15000; // å›ºå®š15ç§’åˆ·æ–°é—´éš”
            feedTimer = setInterval(() => {
                // åå°æ ‡ç­¾é¡µæ—¶é™ä½åˆ·æ–°é¢‘ç‡
                if (backgroundTab) {
                    if (Math.random() < 0.1) { // 10%æ¦‚ç‡åˆ·æ–°
                        pollFeed();
                    }
                } else {
                    pollFeed();
                }
            }, iv);
            pollFeed(true);
        }

        function refreshAll(force=false){
            if (force) {
                consecutiveErrors = 0;
                if (feedTimer) {
                    clearInterval(feedTimer);
                    feedTimer = null;
                }
                // é‡æ–°ä»â€œç°åœ¨â€å¼€å§‹è®¡ç®—15sçš„è‡ªåŠ¨åˆ·æ–°å‘¨æœŸï¼Œå¹¶ä¼šç«‹å³æ‹‰å–ä¸€æ¬¡
                setupTimers();
                return;
            }
            return pollFeed(false);
        }

        async function pollFeed(force=false){
            try {
                const url = FEED_URL;
                const fetchOptions = force ? { cache: 'no-cache' } : {};
                const res = await fetch(url, fetchOptions);
                if (!res.ok) throw new Error('feed http ' + res.status);
                const data = await res.json();
                if (!data || !Array.isArray(data.items)) throw new Error('feed invalid');
                
                // è®¡ç®—æ•°æ®å“ˆå¸Œï¼Œé¿å…æ— æ„ä¹‰çš„DOMæ›´æ–°
                const dataHash = JSON.stringify(data.items.map(item => ({
                    symbol: item.symbol,
                    status: item.status,
                    lastPrice: item.metrics?.lastPrice,
                    multiplierDays: item.multiplier_days
                })));
                
                if (dataHash === lastDataHash && !force) {
                    consecutiveErrors = 0;
                    return; // æ•°æ®æœªå˜åŒ–ï¼Œè·³è¿‡DOMæ›´æ–°
                }
                lastDataHash = dataHash;
                if (TOKENS.length === 0) {
                    TOKENS = data.items.map(item => ({
                        key: item.key,
                        display: (item.display || item.key).replace('/USDT', ''), 
                        symbol: item.symbol,
                        multiplier_days: item.multiplier_days || 0
                    }));
                    renderTableSkeleton();
                } 
                // æŒ‰ç¨³å®šåº¦æ’åºï¼šç»¿è‰²(ç¨³å®š) > é»„è‰²(å¾…è§‚å¯Ÿ) > çº¢è‰²(ä¸ç¨³å®š)
                const getStabilityPriority = (item) => {
                    if (!item.mapped) return 99; // å¾…æ˜ å°„æ”¾æœ€å
                    const metrics = item.metrics || {};
                    const trend5m = item.trend5m ?? null;
                    const status = calculateStatus(metrics, trend5m);
                    if (status.color === 'green') return 1; // ç¨³å®š
                    if (status.color === 'yellow') return 2; // å¾…è§‚å¯Ÿ
                    return 3; // ä¸ç¨³å®š
                };
                
                const allItems = data.items.sort((a, b) => {
                    const priorityA = getStabilityPriority(a);
                    const priorityB = getStabilityPriority(b);
                    if (priorityA !== priorityB) return priorityA - priorityB;
                    // åŒç­‰ç¨³å®šåº¦æŒ‰åç§°æ’åº
                    return (a.display || a.key).localeCompare(b.display || b.key);
                });
                
                // é‡æ–°æ¸²æŸ“è¡¨æ ¼ä»¥ä¿æŒæ’åºé¡ºåº
                const tbody = document.getElementById('stabilityBody');
                tbody.innerHTML = '';
                
                allItems.forEach(item => {
                    const sym = item.symbol || 'ALPHA_XXXUSDT';
                    const displayName = (item.display || item.key).replace('/USDT', '');
                    const multiplierDays = item.multiplier_days || 0;
                    
                    // åˆ›å»ºè¡Œ
                    const row = document.createElement('tr');
                    row.setAttribute('data-symbol', sym);
                    
                    if (!item.mapped) {
                        row.innerHTML = `
                            <td><strong>${displayName}</strong></td>
                            <td data-field="status"><span class="status-chip status-yellow"><span class="dot yellow"></span><span>å¾…æ˜ å°„</span></span></td>
                            <td class="number" data-field="lastPrice">-</td>
                            <td class="number" data-field="multiplierDays">${multiplierDays}</td>
                        `;
                    } else {
                        const metrics = item.metrics || {};
                        const trend5m = item.trend5m ?? null;
                        const status = calculateStatus(metrics, trend5m);
                        const cls = status.color==='green'?'status-green':(status.color==='yellow'?'status-yellow':'status-red');
                        const dot = status.color==='green'?'green':(status.color==='yellow'?'yellow':'red');
                        const localizedText = getLocalizedStatusText(status.text);
                        
                        row.innerHTML = `
                            <td><strong>${displayName}</strong></td>
                            <td data-field="status"><span class="status-chip ${cls}"><span class="dot ${dot}"></span><span>${localizedText}</span></span></td>
                            <td class="number" data-field="lastPrice">${formatNumber(metrics.lastPrice, 8)}</td>
                            <td class="number" data-field="multiplierDays">${multiplierDays}</td>
                        `;
                    }
                    
                    tbody.appendChild(row);
                });
                consecutiveErrors = 0;
                hideError();
            } catch (e) {
                consecutiveErrors++;
                console.warn('Feed fetch error:', e.message, 'consecutive:', consecutiveErrors);
                
                // è¿ç»­é”™è¯¯3æ¬¡ä»¥ä¸Šæ—¶æš‚åœè‡ªåŠ¨åˆ·æ–°
                if (consecutiveErrors >= 3) {
                    if (feedTimer) {
                        clearInterval(feedTimer);
                        feedTimer = null;
                    }
                    showError('è¿æ¥å¼‚å¸¸ï¼Œå·²æš‚åœè‡ªåŠ¨åˆ·æ–°ã€‚ç‚¹å‡»å³ä¸Šè§’æŒ‰é’®æ‰‹åŠ¨é‡è¯•ã€‚');
                } else {
                    showError(`è¯»å–æ•°æ®å¤±è´¥ (${consecutiveErrors}/3)ï¼Œè‡ªåŠ¨é‡è¯•ä¸­...`);
                }
            }
        }

        function renderRow(symbol, metrics, trend5m, status, multiplierDays){
            const row = document.querySelector(`tr[data-symbol="${symbol}"]`);
            if (!row) return;
            if (String(symbol).includes('XXX')) {
                const cell = row.querySelector('[data-field="status"]');
                if (cell) cell.innerHTML = `<span class="status-chip status-yellow"><span class="dot yellow"></span><span>å¾…æ˜ å°„</span></span>`;
                return;
            }
            
            // æ›´æ–°æœ€æ–°ä»·
            setText(row,'lastPrice', formatNumber(metrics.lastPrice, 8));
            
            // æ ¹æ®æ–°è§„åˆ™è®¡ç®—çŠ¶æ€
            const newStatus = calculateStatus(metrics, trend5m);
            const cell = row.querySelector('[data-field="status"]');
            const cls = newStatus.color==='green'?'status-green':(newStatus.color==='yellow'?'status-yellow':'status-red');
            const dot = newStatus.color==='green'?'green':(newStatus.color==='yellow'?'yellow':'red');
            const localizedText = getLocalizedStatusText(newStatus.text);
            cell.innerHTML = `<span class="status-chip ${cls}"><span class="dot ${dot}"></span><span>${localizedText}</span></span>`;
            
            // æ›´æ–°4å€å‰©ä½™å¤©æ•° - ç›´æ¥ä½¿ç”¨APIä¼ å…¥çš„æ•°æ®
            setText(row, 'multiplierDays', multiplierDays || '0');
        }

        function calculateStatus(metrics, trend5m) {
            // å¦‚æœ60sæ— æˆäº¤ï¼Œç›´æ¥åˆ¤çº¢
            if (!metrics.tpm || metrics.tpm === 0) {
                return { color: 'red', text: 'no_trade' };
            }

            const range = metrics.rangeBps || 0;
            const vol = metrics.volBps || 0;
            const spike = metrics.spikeRatio || 0;
            const trend = trend5m || 0;

            // ç»¿è‰²æ¡ä»¶ï¼šâ‰¤6/â‰¤3/â‰¤5% ä¸” 5mè¶‹åŠ¿â‰¤20bps
            if (range <= THRESHOLDS.green.range && 
                vol <= THRESHOLDS.green.vol && 
                spike <= THRESHOLDS.green.spike && 
                Math.abs(trend) <= THRESHOLDS.green.trend5m) {
                return { color: 'green', text: 'stable' };
            }

            // é»„è‰²æ¡ä»¶ï¼šâ‰¤15/â‰¤8/â‰¤15% ä¸” 5mâ‰¤50bps
            if (range <= THRESHOLDS.yellow.range && 
                vol <= THRESHOLDS.yellow.vol && 
                spike <= THRESHOLDS.yellow.spike && 
                Math.abs(trend) <= THRESHOLDS.yellow.trend5m) {
                return { color: 'yellow', text: 'moderate' };
            }

            // å¦åˆ™çº¢è‰²
            return { color: 'red', text: 'unstable' };
        }

        function setText(row, field, v){
            const el = row.querySelector(`[data-field="${field}"]`);
            if (el) el.textContent = (v==null || v===undefined || Number.isNaN(v)) ? '-' : v;
        }

        function formatNumber(v, maxLen){
            if (v==null || !isFinite(v)) return null;
            const s = v.toString();
            if (s.includes('.')) {
                const [a,b] = s.split('.');
                return `${a}.${b.slice(0, Math.min(maxLen||8, 8))}`;
            }
            return s;
        }

        function formatBps(v){
            if (v==null || !isFinite(v)) return '-';
            return Math.round(v).toString();
        }

        function formatPercent(v){
            if (v==null || !isFinite(v)) return '-';
            return (v*100).toFixed(1)+'%';
        }

        function showError(msg){
            const box = document.getElementById('errorBox');
            box.style.display = 'block';
            box.textContent = msg;
        }

        function hideError(){
            const box = document.getElementById('errorBox');
            box.style.display = 'none';
            box.textContent = '';
        }

        function startCountdown(){
            countdownSeconds = 15;
            updateCountdownDisplay();
            if (countdownTimer) clearInterval(countdownTimer);
            countdownTimer = setInterval(() => {
                countdownSeconds--;
                updateCountdownDisplay();
                if (countdownSeconds <= 0) {
                    resetCountdown();
                }
            }, 1000);
        }

        function resetCountdown(){
            if (countdownTimer) clearInterval(countdownTimer);
            const el = document.getElementById('countdownNumber');
            if (el) el.textContent = '15';
            // é‡å¯åœ†ç¯æ—‹è½¬åŠ¨ç”»ï¼ˆé€šè¿‡æ›¿æ¢èŠ‚ç‚¹é‡ç½® ::before åŠ¨ç”»ï¼‰
            const circle = document.querySelector('.countdown-circle');
            if (circle && circle.parentNode) {
                const newCircle = circle.cloneNode(true);
                circle.parentNode.replaceChild(newCircle, circle);
            }
            startCountdown();
        }

        function updateCountdownDisplay(){
            const el = document.getElementById('countdownNumber');
            if (el) el.textContent = countdownSeconds;
        }

        function getLocalizedStatusText(englishText) {
            const translations = {
                'stable': 'ç¨³å®š',
                'moderate': 'ä¸€èˆ¬', 
                'unstable': 'ä¸ç¨³å®š',
                'no_trade': 'æ— æˆäº¤',
                'pending': 'å¾…æ˜ å°„'
            };
            return translations[englishText] || englishText;
        }
    </script>
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "s8evkid0ub");
    </script>    
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'984ac7b5fc14ed36',t:'MTc1ODgwNjAxOQ=='};var a=document.createElement('script');a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"05b2f73255d64509b38e379d9142b573","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>
